## Dockerfile을 사용하여 자체 이미지 빌드하기

커스텀 이미지를 빌드하려면 Dockerfile이라는 파일을 만들어야 한다. Dockerfile은 도커에 의해 식별되는 특별한 이름이다.

이 파일에는 자체 이미지를 빌드할 때 실행하려는 도커에 대한 명령을 작성해야 한다. 일반적으로 FROM 명령으로 시작한다. 먼저, FROM을 통해 다른 베이스 이미지에 자체 이미지를 구축할 수 있다. 물론 이론적으로 도커 이미지는 처음부터 빌드할 수 있지만 코드에 필요한 기타 도구와 같은 운영 체제 레이어가 필요하다.

지금부터 노드 이미지를 빌드해 볼 것이다. 위에서 본 것처럼 `FROM` 명령어로 시스템에 존재하거나 도커 허브 상의 노드 이미지를 가지고 오는 것으로 시작한다. 다음 단계로 도커에게 로컬 머신에 있는 파일이 이미지에 들어가야 하는지 알려야 한다. `COPY` 명령을 사용한다. 여기에서 실행할 매우 간단한 명령은 `copy . .` 이다. 기본적으로 여기에서 두 개의 경로를 지정한다. 첫 번째 경로는 컨테이너의 외부, 이미지의 외부 경로이며 이미지로 복사되어야 할 파일들이 있는 곳이다. 여기에 `'.'`을 넣으면, 이는 도커에게 기본적으로 Dockerfile이 포함된 동일한 폴더임을 알리는 것이다. 하지만 Dockerfile은 제외된다. 따라서 이 첫 번째 `'.'`은 이 프로젝트의 모든 폴더, 하위 폴더 및 파일을 복사해야 한다고 도커에게 알리는 것이다. 두 번째 `'.'`은 그 파일을 저장해야 하는 이미지 내부의 경로이다. 모든 이미지와 이미지를 기반으로 생성된 모든 컨테이너에는 로컬 머신의 파일 시스템에서 완전히 분리된 자체 내부 파일 시스템이 있다. 실제로 여기에서는 전적으로 사용자가 선택한 서브 폴더를 사용하는 것이 좋다. 원하는 대로 이름을 지정할 수 있는데, 여기에서는 `/app` 이라고 할 것이다. 이제 Dockerfile과 동일한 폴더에 있는 모든 파일과 거기에 있는 모든 하위 폴더가 컨테이너 내부의 `app` 폴더에 복사된다. 이 폴더가 존재하지 않는 경우에는 이미지와 컨테이너에 생성된다. 이제 다음 단계로 `npm install`을 실행해야 한다. 도커에도 이를 수행할 수 있는 명령어가 있다. 모든 로컬 파일을 이미지에 복사한 후 이미지에서 명령을 `RUN`하고 싶다고 알릴 수 있다. 그전에 `npm install`도 app 폴더 내에서 실행해야 하기 때문에 작업 디렉토리를 설정하는 `WORKDIR` 명령을 작성한다. 위와 동일하게 `/app`으로 설정했다. 이것은 도커에게 모든 후속 명령이 그 폴더 내부에서 실행될 것임을 알리는 것이다. `RUN`뿐만 아니라 `COPY`도 이 작업 디렉토리를 기준으로 실행된다. 하지만 여기에서는 명시적으로 절대 경로인 `/app`이라고 설정하는 것이 좋다. 파일을 복사할 위치를 명확히 알 수 있고, 현재 작업 디렉토리가 무엇인지 보기 위해 그 파일을 추측하거나 살펴볼 필요가 없기 때문이다. 마지막 명령은 모든 작업이 완료되면 서버를 시작하라는 것이다. `RUN node server.js`라고 생각할 수 있지만 틀렸다. 이미지가 빌드될 때마다 실행되기 때문에 이 명령은 올바르지 않다. 이미지를 기반으로 컨테이너를 시작하는 경우에만 서버를 시작하려면 `CMD` 명령을 사용해야 한다. 그런데 `CMD`의 경우, 구문이 약간 다르다. `[”node”, “server.js”]`와 같이 명령을 두 개의 문자열로 분할해 배열에 담는다. 도커에게 이미지를 기반으로 컨테이너가 생성될 때마다 그 컨테이너 내부에 있는 node 명령을 사용하여 server.js 파일을 실행하도록 지시한다. 마지막으로 도커 컨테이너는 격리되어 있기 때문에 이 노드 웹 서버는 포트 80에서 수신 대기하게 된다. 컨테이너 내부의 노드 애플리케이션에서 포트 80을 수신할 때 컨테이너는 그 포트를 우리의 로컬 머신에 노출하진 않는다. 따라서 컨테이너 내부에서만 무언가를 수신 대기 중이기 때문에 그 포트에서 수신할 수 없는 것이다. 이 컨테이너가 시작될 때 우리의 로컬 시스템에 특정 포트를 노출하고 싶다는 것을 도커에 알리는 EXPOSE 80 명령을 추가해야 한다. 도커 이미지에 대한 모든 설정 명령으로 Dockerfile을 완성했다.

```jsx
# Dockerfile

FROM node

WORKDIR /app

COPY . /app

RUN npm install

EXPOSE 80

CMD ["node", "server.js"]
```
