## 이미지 레이어 이해하기

도커는 레이어 기반 아키텍쳐이다. 이미지를 빌드하고 해당 이미지를 다시 빌드하게 되면 변경된 부분의 명령과 그 이후의 모든 명령이 재실행된다. docker build .을 실행하여 이 이미지를 다시 빌드하면 매우 빠르게 완료된다는 걸 알 수 있다. 이때, Using cache(캐쉬 사용)이라는 메시지를 볼 수 있다. 도커가 기본적으로 명령어를 다시 실행했을 때의 결과가 이전과 동일하다는 것을 인식했기 때문이다. 이미지를 빌드할 때마다 도커는 모든 명령 결과를 캐시하고 이미지를 다시 빌드할 때 명령을 다시 실행할 필요가 없으면 이러한 캐시된 결과를 사용한다. 이것을 레이어 기반 아키텍처라고 한다.

하나의 레이어가 변경될 때마다 하단의 다른 모든 레이어가 다시 빌드된다. 도커는 npm install 레이어가 이전과 동일한 결과를 산출할지 그 여부를 알 수 없다. 한 레이어가 변경될 때마다 모든 후속 레이어도 다시 실행되므로 npm install이 다시 실행된다.

하지만 프로젝트의 종속성을 관리하는 package.json에서 무언가를 변경하지 않는 한 npm install을 다시 실행할 필요가 없다. npm install을 실행하기 전에 package.json 파일도 /app에 복사하는 방식으로 최적화할 수 있다. package.json 파일을 선택하여 app 폴더에 복사한 다음 npm install을 실행하고 다른 코드를 복사한다. 앞으로는 소스 코드를 변경할 때마다 소스 코드 복사 명령 앞의 레이어가 무효화되지 않는다. npm install은 다시 실행되지 않는다는 것이다.
