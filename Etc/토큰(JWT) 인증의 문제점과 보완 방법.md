# 토큰(JWT) 인증의 문제점과 보안 방법

## 목차

1. 현재 JWT 전략
2. JWT 문제점
3. 보완책

### 1. 현재 JWT 전략
|이름|저장 방식|유효기간|취약 공격|
|-------|---|---|---|
|액세스 토큰|LocalStorage|30분|XSS|
|리프래쉬 토큰|Cookie|14일|CSRF|

**내부 검증 로직:** 

1. `토큰이 존재하는지 확인`
2. `토큰을``secret key로 verify해 일치하는지 확인` 
3. `Redis 내에 저장된 토큰과 비교` 
4. `해당 유저가 존재하는지 확인`

### 2. JWT 문제점

일반적으로 토큰 전략은 XSS, CSRF 공격에 취약하다고 알려져 있다. 특히 액세스 토큰은 XSS 공격에, 리프래시 토큰은 CSRF 공격에 취약한데, 각각의 공격 방식과 현재 보편적으로 활용되고 있는 예방책에 대해서 알아보자.

1. **XSS 공격**
- 웹 상에서 가장 기초적인 취약점 공격 방법의 일종으로, 악의적인 사용자가 공격하고자 하는 사이트에 스크립트를 심는 기법을 말한다. 공격에 성공하면 사이트에 접속한 사용자는 삽입된 코드를 실행하게 되며, 보통 의도치 않은 행동을 수행하게 하고 쿠키나 세션 토큰 등의 민감한 정보를 탈취한다.

아래는 잘 알려진 XSS 공격 기법이다.

- 스크립트 태그 활용: `<script>alert('XSS');</script>`
- 자바스크립트 링크 활용: `<a href="javascript:alert('XSS')">XSS</a>`
- 이벤트 속성 활용: `<img src="#" onerror="alert('XSS')">`
- `<a href="&#x6A;&#x61;&#x76;&#x61;&#x73;&#xA;&#x63;&#x72;&#x69;&#x70;&#x74;&#xA;&#x3A;&#xA;&#x61;&#x6C;&#x65;&#x72;&#x74;&#xA;&#x28;&#x27;&#x58;&#x53;&#x53;&#x27;&#x29;">XSS</a>`

위와 같이 내용 또는 스크립트를 난독화해 보안을 뚫으려는 시도가 계속되고 있다.

이를 방어하기 위해서는 데이터를 입력할 때와 출력할 때, 스크립트 태그, 자바스크립트 태그 등을 필터링하고 가능하면 클라이언트에서도 막을 수 있는 수단을 구성하는 것이 좋다. 사용할 필터를 라이브러리로 제작하거나, 기존에 존재하는 라이브러리를 이용할 수 있다.([sanitize-html](https://www.npmjs.com/package/sanitize-html))

또한 XSS 공격을 예방하기 위해 토큰을 쿠키에 저장할 것을 권장하는데, 그 이유는 서버에서 클라이언트로 토큰을 전달할 때 `httpOnly: true` 옵션으로 자바스크립트에서 접근할 수 없도록 제어할 수 있기 때문이다. 

1. **CSRF 공격**
- 웹 애플리케이션 취약점 중 하나로 사용자가 자신의 의지와 무관하게 공격자가 의도한 행동을 해서 특정 웹페이지를 보안에 취약하게 한다거나 수정, 삭제 등의 작업을 하게 만드는 공격 방법이다.

예시: 특정 사이트의 사용자 개인 비밀번호 변경을 하는 주소 패턴이 `'abc.com/user.do?cmd=user_passwd_change&user=admin&newPwd=1234'`라면 이러한 링크를 사용자의 메일로 보내는데, 만약 사용자가 메일을 읽게 되면 해당 사용자의 패스워드가 1234로 초기화 될 수 있다. 만약 관리자 계정 패스워드를 바꾸는데 이용한다면 해당 사이트의 모든 정보가 해킹 당할 수 있다.

토큰을 쿠키에 저장하게 되면 Request 요청에 자동으로 토큰이 전달되기 때문에 CSRF 공격에 취약하다고 말한다. 이를 방어하기 위해 사용하는 2가지 방법이 있다.

- **Referrer 검증**: 서버에서 request의 referrer을 확인하여 domain이 일치하는 지 검증하는 방법이다. 일반적으로 referrer 검증만으로 대부분의 CSRF 공격을 방어할 수 있다. 하지만 같은 도메인 내의 페이지에 XSS 취약점이 있는 경우는 CSRF 공격에 취약해질 수 있고, Paros나 Zap, fiddler같은 프로그램으로 조작이 가능하다는 단점이 있다.

- ****CSRF 토큰:**** Security Token을 활용해 보안을 강화할 수 있다. 임의의 난수값을 저장하고 사용자의 요청에 해당 난수 값을 포함시켜 전송한다. 이후 서버에서 요청을 받을 때마다 저장된 토큰값과 요청 파라미터에 전달되는 토큰값이 일치하는 지 검증한다.

## 3. 보완책

- 일반적인 XSS 공격에 대한 필터링 적용
- 액세스 토큰의 저장 방식을 쿠키 저장 방식으로 변경하고, Referrer 검증과 CSRF 토큰을 도입
- IP 보안 방식 채택 논의
    - 서버에 토큰을 저장할 때 웹 브라우저의 접속 IP 주소를 함께 기록해 이후의 요청에서 기록된 IP 주소와 동일한지 검토하는 과정을 추가한다. 기존에 저장된 IP 주소와 다른 IP 주소로 요청을 보냈을 때 접속을 거부하는 방식으로 XSS 공격을 방어할 수 있다.
    - TCP/IP에서 IP주소를 변조하는 것은 매우 어렵기 때문에 IP보안은 토큰 탈취에 대한 강력한 보안방법이다. 하지만 현대의 인터넷 환경에서는 여러가지 단점도 가진다.
        - 사용자 편의성이 감소한다. 노트북 사용자가 이동하게 되면 이미 로그인한 상태임에도 불구하고 새로운 장소에서 접속할 때마다 로그인을 새로 해야 한다.
        - 이동형 환경에 적용할 수 없다. 휴대전화와 같이 이동시에 수시로 IP주소가 변경되는 상황에서는 IP보안 적용이 현실적으로 불가능하다. 때문에 네이버나 다음에서도 PC환경에서는 IP보안을 기본으로 하지만 모바일 환경에서는 IP보안을 지원하지 않는다.
        - NAT(Network Address Translation) 환경에서는 같은 환경내의 모든 사람이 **동일한 공인IP주소**를 가진다. 음식점이나 커피숍의 WIFI와 같이 네트워크 감청이 쉬운 환경에서는 IP보안이 작동하지 않는다.

## 참고:

[https://webhack.dynu.net/?idx=20161231.001](https://webhack.dynu.net/?idx=20161231.001)

[https://namu.wiki/w/XSS](https://namu.wiki/w/XSS)

[https://namu.wiki/w/CSRF](https://namu.wiki/w/CSRF)

[https://junhyunny.github.io/information/security/spring-boot/spring-security/cross-site-reqeust-forgery/](https://junhyunny.github.io/information/security/spring-boot/spring-security/cross-site-reqeust-forgery/)
